<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Guild Join/Leave</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Whitney:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #191919;
    --sidebar: #202225;
    --main: #36393f;
    --hover: #32353b;
    --accent: #5865f2;
    --text: #dcddde;
    --text-muted: #8e9297;
    --success: #43b581;
    --danger: #f04747;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { 
    font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    background: var(--bg); 
    color: var(--text);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .container {
    width: 480px;
    height: 720px;
    background: var(--main);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
  }
  header {
    background: #2f3136;
    padding: 16px;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
    border-bottom: 1px solid #202225;
  }
  .content { flex: 1; padding: 20px; overflow-y: auto; }
  .input-group { margin-bottom: 16px; }
  label { font-size: 12px; font-weight: 600; color: #b9bbbe; text-transform: uppercase; letter-spacing: 0.5px; }
  textarea, input[type=text], input[type=number] {
    width: 100%;
    background: #2f3136;
    border: none;
    border-radius: 6px;
    padding: 10px 12px;
    margin-top: 6px;
    color: #dcddde;
    font-family: inherit;
    font-size: 14px;
  }
  textarea { resize: vertical; min-height: 80px; }
  button {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  #startBtn { background: var(--accent); color: white; }
  #startBtn:hover { background: #4752c4; }
  #stopBtn { background: var(--danger); color: white; display: none; }
  #stopBtn:hover { background: #da3b3b; }
  .status {
    text-align: center;
    padding: 12px;
    font-weight: 600;
    margin: 12px 0;
    border-radius: 6px;
    background: #2f3136;
  }
  .log {
    background: #2f3136;
    border-radius: 6px;
    padding: 12px;
    height: 200px;
    overflow-y: auto;
    font-family: Consolas, monospace;
    font-size: 13px;
    line-height: 1.5;
    margin-top: 12px;
  }
  .log .success { color: var(--success); }
  .log .error { color: var(--danger); }
  .log .info { color: #00b0f4; }
</style>
</head>
<body>
<div class="container">
  <header>Guild Join/Leave</header>
  <div class="content">
    <div class="status" id="status">待機中 — 自分のサーバーのみ使用可</div>

    <div class="input-group">
      <label>トークン（改行で複数可）</label>
      <textarea id="tokens" placeholder="トークンを貼り付けてください"></textarea>
    </div>

    <div class="input-group">
      <label>招待コード</label>
      <input type="text" id="invite" placeholder="sampleもしくはdiscord.gg/sample">
    </div>

    <div class="input-group">
      <label>ニックネーム（任意）</label>
      <input type="text" id="nickname" placeholder="参加時に設定してください">
    </div>

    <div class="input-group">
      <label>自己紹介（任意）</label>
      <textarea id="bio" rows="2" placeholder="参加時に設定してください"></textarea>
    </div>

    <div class="input-group">
      <label>遅延（ms）</label>
      <input type="number" id="delay" value="5000" min="2000">
    </div>

    <button id="startBtn">参加開始</button>
    <button id="stopBtn">全員退出</button>

    <div class="log" id="log">ログがここに表示されます...</div>
  </div>
</div>

<script>
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
let running = false;
let workers = [];

function log(msg, type = 'info') {
  const time = new Date().toLocaleTimeString('ja-JP');
  logEl.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
  logEl.scrollTop = logEl.scrollHeight;
}

async function safeFetch(url, options) {
  try {
    const res = await fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "X-Super-Properties": btoa(JSON.stringify({os:"Windows",browser:"Chrome",device:"",system_locale:"ja-JP",browser_user_agent:navigator.userAgent}))
      }
    });
    return res;
  } catch (e) { log(`ネットワークエラー: ${e.message}`, 'error'); }
}

async function join(token, invite, nick, bio) {
  try {
    const code = invite.split('/').pop();
    const res = await safeFetch(`https://discord.com/api/v9/invites/${code}`, {
      method: "POST",
      headers: { Authorization: token, "Content-Type": "application/json" },
      body: "{}"
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    log(`参加成功 → ${data.guild.name}`, 'success');

    if (nick) {
      await safeFetch(`https://discord.com/api/v9/guilds/${data.guild.id}/members/@me`, {
        method: "PATCH",
        headers: { Authorization: token, "Content-Type": "application/json" },
        body: JSON.stringify({ nick })
      });
    }
    if (bio) {
      await safeFetch("https://discord.com/api/v9/users/@me/settings", {
        method: "PATCH",
        headers: { Authorization: token, "Content-Type": "application/json" },
        body: JSON.stringify({ bio })
      });
    }
    return data.guild.id;
  } catch (e) {
    log(`参加失敗: ${e.message}`, 'error');
    return null;
  }
}

async function leave(token, guildId) {
  try {
    await safeFetch(`https://discord.com/api/v9/users/@me/guilds/${guildId}`, {
      method: "DELETE",
      headers: { Authorization: token }
    });
    log(`退出完了`, 'info');
  } catch (e) { log(`退出失敗: ${e.message}`, 'error'); }
}

document.getElementById('startBtn').onclick = async () => {
  if (running) return;
  running = true;
  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'block';
  statusEl.textContent = "参加中...";

  const tokens = document.getElementById('tokens').value.trim().split('\n').filter(t => t.trim());
  const invite = document.getElementById('invite').value.trim();
  const nick = document.getElementById('nickname').value.trim() || null;
  const bio = document.getElementById('bio').value.trim() || null;
  const delay = parseInt(document.getElementById('delay').value);

  workers = [];

  for (const token of tokens) {
    if (!running) break;
    const gid = await join(token.trim(), invite, nick, bio);
    if (gid) workers.push({ token: token.trim(), guildId: gid });
    await new Promise(r => setTimeout(r, delay + Math.random() * 2000)); // ランダム遅延で検知回避
  }
  statusEl.textContent = `${workers.length}アカウントが参加完了`;
};

document.getElementById('stopBtn').onclick = async () => {
  running = false;
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('startBtn').style.display = 'block';
  statusEl.textContent = "退出中...";
  for (const w of workers) {
    await leave(w.token, w.guildId);
  }
  workers = [];
  statusEl.textContent = "待機中";
};
</script>
</body>
</html>
